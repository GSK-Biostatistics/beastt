<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Calculate Conditional Drift and Treatment Effect for Time-to-Event Outcome Models — calc_cond_weibull • beastt</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Calculate Conditional Drift and Treatment Effect for Time-to-Event Outcome Models — calc_cond_weibull"><meta property="og:description" content="In order to properly generate time-to-event (TTE) outcome data for the
internal trial as part of a simulation study that investigates inverse
probability weighting, we need to translate the desired marginal drift and
treatment effect to the corresponding conditional drift and treatment effect
that can then be added into a TTE outcome model (e.g., Weibull proportional
hazards regression model) used to simulate response data."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">beastt</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/binary.html">Binary Outcome</a>
    </li>
    <li>
      <a href="../articles/continuous.html">Normal Outcome (Known SD)</a>
    </li>
    <li>
      <a href="../articles/tte.html">Time-to-Event Outcome</a>
    </li>
  </ul></li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/GSK-Biostatistics/beastt/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Calculate Conditional Drift and Treatment Effect for Time-to-Event Outcome Models</h1>
    <small class="dont-index">Source: <a href="https://github.com/GSK-Biostatistics/beastt/blob/main/R/tte-sim.R" class="external-link"><code>R/tte-sim.R</code></a></small>
    <div class="hidden name"><code>calc_cond_weibull.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>In order to properly generate time-to-event (TTE) outcome data for the
internal trial as part of a simulation study that investigates inverse
probability weighting, we need to translate the desired marginal drift and
treatment effect to the corresponding conditional drift and treatment effect
that can then be added into a TTE outcome model (e.g., Weibull proportional
hazards regression model) used to simulate response data.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">calc_cond_weibull</span><span class="op">(</span></span>
<span>  <span class="va">population</span>,</span>
<span>  <span class="va">weibull_ph_mod</span>,</span>
<span>  <span class="va">marg_drift</span>,</span>
<span>  <span class="va">marg_trt_eff</span>,</span>
<span>  <span class="va">analysis_time</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-population">population<a class="anchor" aria-label="anchor" href="#arg-population"></a></dt>
<dd><p>A very large data frame (e.g., number of rows \(\ge\)
100,000) where the columns correspond to the covariates defined in the
<code>survreg</code> object for the Weibull proportional hazards model. This data
frame should be constructed to represent the population of the internal
trial according to the assumed covariate distributions (possibly imbalanced
from the external data).</p></dd>


<dt id="arg-weibull-ph-mod">weibull_ph_mod<a class="anchor" aria-label="anchor" href="#arg-weibull-ph-mod"></a></dt>
<dd><p><code>survreg</code> object corresponding to a Weibull
proportional hazards model fit using the external data</p></dd>


<dt id="arg-marg-drift">marg_drift<a class="anchor" aria-label="anchor" href="#arg-marg-drift"></a></dt>
<dd><p>Vector of marginal drift values</p></dd>


<dt id="arg-marg-trt-eff">marg_trt_eff<a class="anchor" aria-label="anchor" href="#arg-marg-trt-eff"></a></dt>
<dd><p>Vector of marginal treatment effect values</p></dd>


<dt id="arg-analysis-time">analysis_time<a class="anchor" aria-label="anchor" href="#arg-analysis-time"></a></dt>
<dd><p>A single time point when survival probabilities will be
calculated</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>tibble of all combinations of the marginal drift and treatment
effect. For each row the conditional drift and treatment effect has been
calculated as well as the true marginal survival probabilities at time <code>t</code>
for the control and treatment populations.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>In simulation studies that investigate the properties of inverse
probability weighted Bayesian dynamic borrowing, scenarios should be
considered in which the underlying survival probabilities at some
prespecified time \(t\) (<code>analysis_time</code>) for the internal and external
control populations differ by varying amounts due to unmeasured confounding
(i.e., drift, where positive values indicate a higher survival probability
for the internal population). While values of drift and treatment effect
(i.e., difference between the survival probabilities at time \(t\) for
the treated and control populations) can be defined on the marginal scale
for simulation studies, we must first convert these values to the
conditional scale and then include these terms, along with covariates, in a
Weibull proportional hazards (PH) regression outcome model when generating
time-to-event (TTE) data for the internal arms. Doing so allows us to
assume a relationship between the covariates and the response variable
while properly accounting for drift and treatment effect.</p>
<p>To identify the conditional drift and treatment effect that correspond to
specified values of marginal drift and treatment effect, we first bootstrap
covariate vectors from the external data (e.g., \(N \ge 100,000\)) to
construct a "population" that represents both the internal trial
(possibly incorporating intentional covariate imbalance) and the external
trial <em>after</em> standardizing it to match the covariate distributions
of the internal trial (allowing us to control for measured confounding
from potential imbalance in the covariate distributions). Measured
confounding can be incorporated into the data generation by bootstrapping
a very large data frame (<code>population</code>) in which the distribution of at
least one covariate is intentionally varied from that of the external data;
additional <em>unmeasured</em> drift can be incorporated through the
translation of specified marginal values (<code>marg_drift</code>) to conditional
values.</p>
<p>Let \(\Delta\) and \(\delta\) denote the marginal and conditional drift,
respectively. For a specified value of \(\Delta\), we can identify the
corresponding \(\delta\) as the value that, when added as an additional
term in the Weibull PH model survival function (i.e., additive change in
the intercept) for each individual in the population, increases/decreases
the population-averaged conditional probabilities of survival at time
\(t\) by an amount approximately equal to \(\Delta\). That is, the
optimal \(\delta\) minimizes</p>
<p>$$\left| \left( \frac{1}{N} \sum_{i=1}^N \exp \left( -\left\{ \exp
  \left( \boldsymbol{x}_i^\prime \boldsymbol{\beta}_{EC} + \delta \right)
  \times t \right\}^{\alpha_{EC}} \right) - \frac{1}{N} \sum_{i=1}^N \exp
  \left( -\left\{ \exp \left( \boldsymbol{x}_i^\prime \boldsymbol{\beta}_{EC}
  \right) \times t \right\}^{\alpha_{EC}} \right) \right) - \Delta \right|,$$</p>
<p>where \(\alpha_{EC}\) is the Weibull shape parameter,
\(\boldsymbol{\beta}_{EC}\) is a vector of regression coefficients, and
\(\boldsymbol{x}_i\) is a vector of covariates (including an intercept
term) from the bootstrapped population of size \(N\). We note that
\(\alpha_{EC} = 1/\sigma_{EC}\) and \(\boldsymbol{\beta}_{EC} =
  -\boldsymbol{\xi}_{EC}\) are calculated as functions of the scale parameter
(\(\sigma_{EC}\)) and coefficients (\(\boldsymbol{\xi}_{EC}\))
estimated by the <code>survreg</code> object that was fit to the external data, and we
assume here that these estimates are the "true" shape and covariate effects
when generating response data. In the formula above, the first and second
terms correspond to the population-averaged conditional survival functions
(i.e., the marginal survival probabilities) at time \(t\) for the
internal control population with drift and the external control population
(with covariate distributions standardized to match the internal trial),
respectively.</p>
<p>If we now denote the marginal and conditional treatment effect by
\(\Gamma\) and \(\gamma\), respectively, we can use a similar process
to identify the optimal \(\gamma\) that approximately corresponds to the
specified value of \(\Gamma\), which is done by minimizing the following:</p>
<p>$$\left| \left( \frac{1}{N} \sum_{i=1}^N \exp \left( -\left\{ \exp
  \left( \boldsymbol{x}_i^\prime \boldsymbol{\beta}_{EC} + \delta + \gamma
  \right) \times t \right\}^{\alpha_{EC}} \right) - \frac{1}{N} \sum_{i=1}^N
  \exp \left( -\left\{ \exp \left( \boldsymbol{x}_i^\prime
  \boldsymbol{\beta}_{EC} + \delta \right) \times t \right\}^{\alpha_{EC}}
  \right) \right) - \Gamma \right|,$$</p>
<p>where the first term is the average of the conditional survival functions
(i.e., the marginal survival probabilities) at time \(t\) for the
internal treated population.</p>
<p>See <a href="https://github.com/GSK-Biostatistics/beastt/blob/e2b41fe90f639924d10c0d94ceff04a74d0ce617/inst/templates/tte-template.R" class="external-link">here</a>
for a simulation example with a time-to-event outcome.</p>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span></span>
<span class="r-in"><span><span class="co"># Model "true" regression coefficients using the external data</span></span></span>
<span class="r-in"><span><span class="va">weibull_ph_mod</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survreg.html" class="external-link">survreg</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">event</span><span class="op">)</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span>, data <span class="op">=</span> <span class="va">ex_tte_df</span>,</span></span>
<span class="r-in"><span>                          dist <span class="op">=</span> <span class="st">"weibull"</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Bootstrap internal control "population" with imbalance w.r.t. covariate 2</span></span></span>
<span class="r-in"><span><span class="va">pop_int_ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="bootstrap_cov.html">bootstrap_cov</a></span><span class="op">(</span><span class="va">ex_tte_df</span>, n <span class="op">=</span> <span class="fl">100000</span>, imbal_var <span class="op">=</span> <span class="va">cov2</span>,</span></span>
<span class="r-in"><span>                              imbal_prop <span class="op">=</span> <span class="fl">0.25</span>, ref_val <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">|&gt;</span></span></span>
<span class="r-in"><span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">cov1</span>, <span class="va">cov2</span>, <span class="va">cov3</span>, <span class="va">cov4</span><span class="op">)</span><span class="op">)</span>     <span class="co"># keep only covariate columns</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Convert the marginal drift and treatment effects to conditional</span></span></span>
<span class="r-in"><span><span class="fu">calc_cond_weibull</span><span class="op">(</span>population <span class="op">=</span> <span class="va">pop_int_ctrl</span>, <span class="va">weibull_ph_mod</span>,</span></span>
<span class="r-in"><span>                  marg_drift <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">.1</span>, <span class="fl">0</span>, <span class="fl">.1</span><span class="op">)</span>, marg_trt_eff <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">.10</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>                  analysis_time <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># A tibble: 6 × 6</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span>   marg_drift marg_trt_eff conditional_drift true_control_surv_prob</span>
<span class="r-out co"><span class="r-pr">#&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>             <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">1</span>       -<span style="color: #BB0000;">0.1</span>          0               0.210                  0.367</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">2</span>       -<span style="color: #BB0000;">0.1</span>          0.1             0.210                  0.367</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">3</span>        0            0               0                      0.467</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">4</span>        0            0.1             0                      0.467</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">5</span>        0.1          0              -<span style="color: #BB0000;">0.223</span>                  0.567</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #BCBCBC;">6</span>        0.1          0.1            -<span style="color: #BB0000;">0.223</span>                  0.567</span>
<span class="r-out co"><span class="r-pr">#&gt;</span> <span style="color: #949494;"># ℹ 2 more variables: conditional_trt_eff &lt;dbl&gt;, true_trt_surv_prob &lt;dbl&gt;</span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Christina Fillmore, Nate Bean, Abi Terry, Ben Arancibia, GlaxoSmithKline Research &amp; Development Limited.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.2.</p>
</div>

      </footer></div>






  </body></html>

