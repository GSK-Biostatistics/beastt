<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Time-to-Event Outcome • beastt</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Time-to-Event Outcome">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">beastt</a>

    <small class="nav-text text-default me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">0.0.3</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/binary.html">Binary Outcome</a></li>
    <li><a class="dropdown-item" href="../articles/continuous.html">Normal Outcome (Known SD)</a></li>
    <li><a class="dropdown-item" href="../articles/tte.html">Time-to-Event Outcome</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/GSK-Biostatistics/beastt/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Time-to-Event Outcome</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/GSK-Biostatistics/beastt/blob/main/vignettes/tte.Rmd" class="external-link"><code>vignettes/tte.Rmd</code></a></small>
      <div class="d-none name"><code>tte.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction-and-data-description">Introduction and Data Description<a class="anchor" aria-label="anchor" href="#introduction-and-data-description"></a>
</h2>
<p>In this example, we illustrate how to use Bayesian dynamic borrowing
(BDB) with the inclusion of inverse probability weighting to balance
baseline covariate distributions between external and internal datasets.
This particular example considers a hypothetical trial with a
time-to-event outcome which we assume to follow a Weibull distribution;
i.e., <span class="math inline">\(Y_i \sim \mbox{Weibull}(\alpha,
\sigma)\)</span> where <span class="math display">\[f(y_i \mid \alpha,
\sigma) = \left( \frac{\alpha}{\sigma} \right) \left( \frac{y_i}{\sigma}
\right)^{\alpha - 1} \exp \left( -\left( \frac{y_i}{\sigma}
\right)^\alpha
\right).\]</span> Define <span class="math inline">\(\boldsymbol{\theta}
= \{\log(\alpha), \beta\}\)</span> where <span class="math inline">\(\beta = -\log(\sigma)\)</span> is the intercept
(i.e., log-inverse-scale) parameter of a Weibull proportional hazards
regression model and <span class="math inline">\(\alpha\)</span> is the
shape parameter.</p>
<p>Our objective is to use BDB with IPWs to construct a posterior
distribution for the probability of surviving past time <span class="math inline">\(t\)</span> in the control arm, <span class="math inline">\(S_C(t | \boldsymbol{\theta})\)</span> (hereafter
denoted as <span class="math inline">\(S_C(t)\)</span> for notational
convenience). For each treatment arm, we will define our prior
distributions with respect to <span class="math inline">\(\boldsymbol{\theta}\)</span> before eventually
obtaining MCMC samples from the posterior distributions of <span class="math inline">\(S_C(t)\)</span> and <span class="math inline">\(S_T(t)\)</span> (i.e., the survival probability at
time <span class="math inline">\(t\)</span> for the active treatment
arm). In this example, suppose we are interested in survival
probabilities at <span class="math inline">\(t=12\)</span> months.</p>
<p>We will use simulated internal and external datasets from the package
where each dataset has a time-to-event response variable (the observed
time at which a participant either had an event or was censored), an
event indicator (1: event; 0: censored), the enrollment time in the
study, the total time since the start of the study, and four baseline
covariates which we will balance.</p>
<p>The external control dataset has a sample size of 150 participants,
and the distributions of the four covariates are as follows: - Covariate
1: normal with a mean and standard deviation of approximately 65 and 10,
respectively - Covariate 2: binary (0 vs. 1) with approximately 30% of
participants with level 1 - Covariate 3: binary (0 vs. 1) with
approximately 40% of participants with level 1 - Covariate 4: binary (0
vs. 1) with approximately 50% of participants with level 1</p>
<p>The internal dataset has 160 participants with 80 participants in
each of the control arm and the active treatment arms. The covariate
distributions of each arm are as follows: - Covariate 1: normal with a
mean and standard deviation of approximately 62 and 8, respectively -
Covariate 2: binary (0 vs. 1) with approximately 40% of participants
with level 1 - Covariate 3: binary (0 vs. 1) with approximately 40% of
participants with level 1 - Covariate 4: binary (0 vs. 1) with
approximately 60% of participants with level 1</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://pkg.mitchelloharawild.com/distributional/" class="external-link">distributional</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://mc-stan.org/rstan/" class="external-link">rstan</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: StanHeaders</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; rstan version 2.32.7 (Stan version 2.32.2)</span></span>
<span><span class="co">#&gt; For execution on a local, multicore CPU with excess RAM we recommend calling</span></span>
<span><span class="co">#&gt; options(mc.cores = parallel::detectCores()).</span></span>
<span><span class="co">#&gt; To avoid recompilation of unchanged Stan programs, we recommend calling</span></span>
<span><span class="co">#&gt; rstan_options(auto_write = TRUE)</span></span>
<span><span class="co">#&gt; For within-chain threading using `reduce_sum()` or `map_rect()` Stan functions,</span></span>
<span><span class="co">#&gt; change `threads_per_chain` option:</span></span>
<span><span class="co">#&gt; rstan_options(threads_per_chain = 1)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">1234</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">int_tte_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;      subjid             y              enr_time         total_time    </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   : 0.7026   Min.   :0.01367   Min.   : 1.309  </span></span>
<span><span class="co">#&gt;  1st Qu.: 40.75   1st Qu.: 6.4188   1st Qu.:0.83781   1st Qu.: 7.268  </span></span>
<span><span class="co">#&gt;  Median : 80.50   Median :12.1179   Median :1.27502   Median :14.245  </span></span>
<span><span class="co">#&gt;  Mean   : 80.50   Mean   : 9.6651   Mean   :1.19144   Mean   :15.427  </span></span>
<span><span class="co">#&gt;  3rd Qu.:120.25   3rd Qu.:12.7287   3rd Qu.:1.58949   3rd Qu.:20.699  </span></span>
<span><span class="co">#&gt;  Max.   :160.00   Max.   :13.9913   Max.   :1.98912   Max.   :58.644  </span></span>
<span><span class="co">#&gt;      event           trt           cov1            cov2             cov3       </span></span>
<span><span class="co">#&gt;  Min.   :0.00   Min.   :0.0   Min.   :46.00   Min.   :0.0000   Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.00   1st Qu.:0.0   1st Qu.:57.00   1st Qu.:0.0000   1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :0.00   Median :0.5   Median :62.00   Median :0.0000   Median :0.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.45   Mean   :0.5   Mean   :61.83   Mean   :0.3688   Mean   :0.3625  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.00   3rd Qu.:1.0   3rd Qu.:67.00   3rd Qu.:1.0000   3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.00   Max.   :1.0   Max.   :85.00   Max.   :1.0000   Max.   :1.0000  </span></span>
<span><span class="co">#&gt;       cov4       </span></span>
<span><span class="co">#&gt;  Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :1.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.5563  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">ex_tte_df</span><span class="op">)</span></span>
<span><span class="co">#&gt;      subjid             y               enr_time          total_time    </span></span>
<span><span class="co">#&gt;  Min.   :  1.00   Min.   : 0.05804   Min.   :0.005329   Min.   : 1.191  </span></span>
<span><span class="co">#&gt;  1st Qu.: 38.25   1st Qu.: 4.45983   1st Qu.:0.857692   1st Qu.: 5.782  </span></span>
<span><span class="co">#&gt;  Median : 75.50   Median : 9.42004   Median :1.308708   Median :10.576  </span></span>
<span><span class="co">#&gt;  Mean   : 75.50   Mean   : 8.58877   Mean   :1.232657   Mean   :12.533  </span></span>
<span><span class="co">#&gt;  3rd Qu.:112.75   3rd Qu.:12.71370   3rd Qu.:1.673582   3rd Qu.:16.549  </span></span>
<span><span class="co">#&gt;  Max.   :150.00   Max.   :14.00703   Max.   :1.975702   Max.   :64.793  </span></span>
<span><span class="co">#&gt;      event             cov1            cov2             cov3       </span></span>
<span><span class="co">#&gt;  Min.   :0.0000   Min.   :37.00   Min.   :0.0000   Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000   1st Qu.:58.00   1st Qu.:0.0000   1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :1.0000   Median :64.00   Median :0.0000   Median :0.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.6267   Mean   :64.28   Mean   :0.3533   Mean   :0.4533  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000   3rd Qu.:70.00   3rd Qu.:1.0000   3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000   Max.   :90.00   Max.   :1.0000   Max.   :1.0000  </span></span>
<span><span class="co">#&gt;       cov4       </span></span>
<span><span class="co">#&gt;  Min.   :0.0000  </span></span>
<span><span class="co">#&gt;  1st Qu.:0.0000  </span></span>
<span><span class="co">#&gt;  Median :0.0000  </span></span>
<span><span class="co">#&gt;  Mean   :0.4733  </span></span>
<span><span class="co">#&gt;  3rd Qu.:1.0000  </span></span>
<span><span class="co">#&gt;  Max.   :1.0000</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="propensity-scores-and-inverse-probability-weights">Propensity Scores and Inverse Probability Weights<a class="anchor" aria-label="anchor" href="#propensity-scores-and-inverse-probability-weights"></a>
</h2>
<p>With the covariate data from both the external and internal datasets,
we can calculate the propensity scores and ATT inverse probability
weights (IPWs) for the internal and external control participants using
the <code>calc_prop_scr</code> function. This creates a propensity score
object which we can use for calculating an approximate inverse
probability weighted power prior in the next step.</p>
<p><strong>Note: when reading external and internal datasets into
<code>calc_prop_scr</code>, be sure to include only the arms in which
you want to balance the covariate distributions (typically the internal
and external control arms).</strong> In this example, we want to balance
the covariate distributions of the external control arm to be similar to
those of the internal control arm, so we will exclude the internal
active treatment arm data from this function.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ps_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_prop_scr.html">calc_prop_scr</a></span><span class="op">(</span>internal_df <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_tte_df</span>, <span class="va">trt</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                        external_df <span class="op">=</span> <span class="va">ex_tte_df</span>,</span>
<span>                        id_col <span class="op">=</span> <span class="va">subjid</span>,</span>
<span>                        model <span class="op">=</span> <span class="op">~</span> <span class="va">cov1</span> <span class="op">+</span> <span class="va">cov2</span> <span class="op">+</span> <span class="va">cov3</span> <span class="op">+</span> <span class="va">cov4</span><span class="op">)</span></span>
<span><span class="va">ps_obj</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Model</span> <span style="color: #00BBBB;">───────────────────────────────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> cov1 + cov2 + cov3 + cov4</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Propensity Scores and Weights</span> <span style="color: #00BBBB;">───────────────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">•</span> Effective sample size of the external arm: 81</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 150 × 4</span></span></span>
<span><span class="co">#&gt;    subjid Internal `Propensity Score` `Inverse Probability Weight`</span></span>
<span><span class="co">#&gt;     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;lgl&gt;</span>                 <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>      1 FALSE                 0.333                        0.500</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>      2 FALSE                 0.288                        0.405</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>      3 FALSE                 0.539                        1.17 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>      4 FALSE                 0.546                        1.20 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>      5 FALSE                 0.344                        0.524</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>      6 FALSE                 0.393                        0.646</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>      7 FALSE                 0.390                        0.639</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>      8 FALSE                 0.340                        0.515</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>      9 FALSE                 0.227                        0.294</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>     10 FALSE                 0.280                        0.389</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># ℹ 140 more rows</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Absolute Standardized Mean Difference</span> <span style="color: #00BBBB;">───────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 4 × 3</span></span></span>
<span><span class="co">#&gt;   covariate diff_unadj diff_adj</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> cov1          0.339  0.046<span style="text-decoration: underline;">1</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> cov2          0.045<span style="text-decoration: underline;">0</span> 0.020<span style="text-decoration: underline;">4</span>  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> cov3          0.160  0.000<span style="text-decoration: underline;">791</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> cov4          0.308  0.008<span style="text-decoration: underline;">57</span></span></span></code></pre></div>
<p>In order to check the suitability of the external data, we can create
a variety of diagnostic plots. The first plot we might want is a
histogram of the overlapping propensity score distributions from both
datasets. To get this, we use the <code>prop_scr_hist</code> function.
This function takes in the propensity score object made in the previous
step, and we can optionally supply the variable we want to look at
(either the propensity score or the IPW). By default, it will plot the
propensity scores. Additionally, we can look at the densities rather
than histograms by using the <code>prop_scr_dens</code> function. When
looking at the IPWs with either the histogram or the density functions,
it is important to note that only the IPWs for external control
participants will be shown because the ATT IPWs for all internal control
participants are equal to 1.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prop_scr_hist.html">prop_scr_hist</a></span><span class="op">(</span><span class="va">ps_obj</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prop_scr_dens.html">prop_scr_dens</a></span><span class="op">(</span><span class="va">ps_obj</span>, variable <span class="op">=</span> <span class="st">"ipw"</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-3-2.png" width="700"></p>
<p>The final plot we might want to look at is a love plot to visualize
the absolute standardized mean differences (both unadjusted and adjusted
by the IPWs) of the covariates between the internal and external data.
To do this, we use the <code>prop_scr_love</code> function. Like the
previous function, the only required parameter for this function is the
propensity score object, but we can also provide a location along the
x-axis for a vertical reference line.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/prop_scr_love.html">prop_scr_love</a></span><span class="op">(</span><span class="va">ps_obj</span>, reference_line <span class="op">=</span> <span class="fl">0.1</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-4-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="approximate-inverse-probability-weighted-power-prior">Approximate Inverse Probability Weighted Power Prior<a class="anchor" aria-label="anchor" href="#approximate-inverse-probability-weighted-power-prior"></a>
</h2>
<p>Now that we have created and assessed our propensity score object, we
can read it into the <code>calc_power_prior_weibull</code> function to
calculate an approximate inverse probability weighted power prior for
<span class="math inline">\(\boldsymbol{\theta}\)</span> under the
control arm, which we denote as <span class="math inline">\(\boldsymbol{\theta}_C = \{\log(\alpha_C),
\beta_C\}\)</span>. Specifically, we approximate the power prior with a
bivariate normal distribution using one of two approximation methods:
(1) Laplace approximation or (2) estimation of the mean vector and
covariance matrix using MCMC samples from the unnormalized power prior
(see the details section of the <code>calc_power_prior_weibull</code>
documentation for more information). In this example, we use the Laplace
approximation which is considerably faster than the MCMC approach.</p>
<p>To approximate the power prior, we need to supply the following
information:</p>
<ul>
<li><p>weighted object (the propensity score object we created
above)</p></li>
<li><p>response variable name (in this case <span class="math inline">\(y\)</span>)</p></li>
<li><p>event indicator variable name (in this case <span class="math inline">\(event\)</span>)</p></li>
<li><p>initial prior for the intercept parameter, in the form of a
normal distributional object (e.g., <span class="math inline">\(\mbox{N}(0, \mbox{sd} = 10)\)</span>)</p></li>
<li><p>scale hyperparameter for the half-normal initial prior for the
shape parameter</p></li>
<li><p>approximation method (either “Laplace” or “MCMC”)</p></li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pwr_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_power_prior_weibull.html">calc_power_prior_weibull</a></span><span class="op">(</span><span class="va">ps_obj</span>,</span>
<span>                                      response <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                      event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                      intercept <span class="op">=</span> <span class="fu"><a href="https://pkg.mitchelloharawild.com/distributional/reference/dist_normal.html" class="external-link">dist_normal</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>                                      shape <span class="op">=</span> <span class="fl">50</span>,</span>
<span>                                      approximation <span class="op">=</span> <span class="st">"Laplace"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot_dist.html">plot_dist</a></span><span class="op">(</span><span class="va">pwr_prior</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="inverse-probability-weighted-robust-mixture-prior">Inverse Probability Weighted Robust Mixture Prior<a class="anchor" aria-label="anchor" href="#inverse-probability-weighted-robust-mixture-prior"></a>
</h2>
<p>We can robustify the approximate multivariate normal (MVN) power
prior for <span class="math inline">\(\boldsymbol{\theta}_C\)</span> by
adding a vague component to create a robust mixture prior (RMP). We
define the vague component to be a MVN distribution with the same mean
vector as the approximate power prior and a covariance matrix that is
equal to the covariance matrix of the approximate power prior multiplied
by <span class="math inline">\(r_{ex}\)</span>, where <span class="math inline">\(r_{ex}\)</span> denotes the number of observed
events in the external control arm. To construct this RMP, we can use
either the <code>robustify_norm</code> or <code>robustify_mvnorm</code>
functions, and we place 0.5 weight on each component. The two components
of the resulting RMP are labeled as “informative” and “vague”.</p>
<p>We can print the mean vectors and covariance matrices of each MVN
component using the functions <code>mix_means</code> and
<code>mix_sigmas</code>, respectively.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">r_external</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">ex_tte_df</span><span class="op">$</span><span class="va">event</span><span class="op">)</span>   <span class="co"># number of observed events</span></span>
<span><span class="va">mix_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/robustify_mvnorm.html">robustify_mvnorm</a></span><span class="op">(</span><span class="va">pwr_prior</span>, <span class="va">r_external</span>, weights <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span><span class="op">)</span>   <span class="co"># RMP</span></span>
<span><span class="fu"><a href="../reference/mix_means.html">mix_means</a></span><span class="op">(</span><span class="va">mix_prior</span><span class="op">)</span>     <span class="co"># mean vectors</span></span>
<span><span class="co">#&gt; $informative</span></span>
<span><span class="co">#&gt; [1]  0.2940907 -2.5655689</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vague</span></span>
<span><span class="co">#&gt; [1]  0.2940907 -2.5655689</span></span>
<span><span class="fu"><a href="../reference/mix_sigmas.html">mix_sigmas</a></span><span class="op">(</span><span class="va">mix_prior</span><span class="op">)</span>    <span class="co"># mean covariance matrices</span></span>
<span><span class="co">#&gt; $informative</span></span>
<span><span class="co">#&gt;             [,1]        [,2]</span></span>
<span><span class="co">#&gt; [1,] 0.016251652 0.003325476</span></span>
<span><span class="co">#&gt; [2,] 0.003325476 0.011868788</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; $vague</span></span>
<span><span class="co">#&gt;           [,1]      [,2]</span></span>
<span><span class="co">#&gt; [1,] 1.5276553 0.3125948</span></span>
<span><span class="co">#&gt; [2,] 0.3125948 1.1156660</span></span>
<span><span class="co">#plot_dist(mix_prior)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="posterior-distributions">Posterior Distributions<a class="anchor" aria-label="anchor" href="#posterior-distributions"></a>
</h2>
<p>To create a posterior distribution for <span class="math inline">\(\boldsymbol{\theta}_C\)</span>, we can pass the
resulting RMP and the internal control data to the
<code>calc_post_weibull</code> function which returns a stanfit object
from which we can extract the MCMC samples for the control parameters.
In addition to returning posterior samples for <span class="math inline">\(\log(\alpha_C)\)</span> and <span class="math inline">\(\beta_C\)</span>, the function returns posterior
samples for the marginal survival probability <span class="math inline">\(S_C(t)\)</span> where the time(s) <span class="math inline">\(t\)</span> can be specified as either a scalar or
vector of numbers using the <code>analysis_time</code> argument.</p>
<p><strong>Note: when reading internal data directly into
<code>calc_post_weibull</code>, be sure to include only the arm of
interest (e.g., the internal control arm if creating a posterior
distribution for <span class="math inline">\(\boldsymbol{\theta}_C\)</span>).</strong></p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_post_weibull.html">calc_post_weibull</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_tte_df</span>, <span class="va">trt</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                  response <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                  event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                  prior <span class="op">=</span> <span class="va">mix_prior</span>,</span>
<span>                                  analysis_time <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">post_control</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt;                     mean      se_mean         sd         2.5%          25%</span></span>
<span><span class="co">#&gt; beta0         -2.6887252 0.0007416549 0.08973077   -2.8896461   -2.7388799</span></span>
<span><span class="co">#&gt; log_alpha      0.3621925 0.0007810625 0.10469515    0.1575300    0.2930159</span></span>
<span><span class="co">#&gt; alpha          1.4444037 0.0011479498 0.15277470    1.1706159    1.3404641</span></span>
<span><span class="co">#&gt; survProb[1]    0.4730793 0.0003307721 0.04382526    0.3949843    0.4439155</span></span>
<span><span class="co">#&gt; lp__        -148.4751404 0.0118123153 1.15276979 -151.6658488 -148.8919240</span></span>
<span><span class="co">#&gt;                     50%          75%        97.5%     n_eff      Rhat</span></span>
<span><span class="co">#&gt; beta0         -2.682493   -2.6292044   -2.5358069 14637.910 1.0000966</span></span>
<span><span class="co">#&gt; log_alpha      0.361368    0.4291120    0.5731935 17967.248 0.9999709</span></span>
<span><span class="co">#&gt; alpha          1.435292    1.5358930    1.7739230 17711.572 0.9999736</span></span>
<span><span class="co">#&gt; survProb[1]    0.470524    0.4987585    0.5702913 17554.608 1.0001324</span></span>
<span><span class="co">#&gt; lp__        -148.108591 -147.6609827 -147.3811442  9523.906 0.9999708</span></span>
<span><span class="co">#plot_dist(post_control)</span></span></code></pre></div>
<p>We can extract and plot the posterior samples of <span class="math inline">\(S_C(t)\)</span>. Here, we plot the samples using a
histogram, however, additional posterior plots (e.g., density curves,
trace plots) can easily be obtained using the <code>bayesplot</code>
package.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_prob_control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">post_control</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"survProb"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>samp <span class="op">=</span> <span class="va">surv_prob_control</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">samp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="va">C</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Posterior Samples of "</span>, <span class="va">S</span><span class="op">[</span><span class="va">C</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#5398BE"</span>, fill <span class="op">=</span> <span class="st">"#5398BE"</span>,</span>
<span>                 position <span class="op">=</span> <span class="st">"identity"</span>, binwidth <span class="op">=</span> <span class="fl">.01</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<p>Next, we create a posterior distribution for the survival probability
<span class="math inline">\(S_T(t)\)</span> for the active treatment arm
at time <span class="math inline">\(t=12\)</span> by reading the
internal data for the corresponding arm into the
<code>calc_post_weibull</code> function. In this case, we use the vague
component of the RMP as our MVN prior.</p>
<p><strong>As noted earlier, be sure to read in only the data for the
internal active treatment arm while excluding the internal control
data.</strong></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vague_prior</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://pkg.mitchelloharawild.com/distributional/reference/dist_multivariate_normal.html" class="external-link">dist_multivariate_normal</a></span><span class="op">(</span>mu <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/mix_means.html">mix_means</a></span><span class="op">(</span><span class="va">mix_prior</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                        sigma <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="../reference/mix_sigmas.html">mix_sigmas</a></span><span class="op">(</span><span class="va">mix_prior</span><span class="op">)</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">post_treated</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_post_weibull.html">calc_post_weibull</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_tte_df</span>, <span class="va">trt</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                  response <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                  event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                  prior <span class="op">=</span> <span class="va">vague_prior</span>,</span>
<span>                                  analysis_time <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">post_treated</span><span class="op">)</span><span class="op">$</span><span class="va">summary</span></span>
<span><span class="co">#&gt;                     mean      se_mean         sd          2.5%          25%</span></span>
<span><span class="co">#&gt; beta0         -2.9467394 0.0014810376 0.14726947   -3.26991147   -3.0353030</span></span>
<span><span class="co">#&gt; log_alpha      0.3526892 0.0015533881 0.15956920    0.02989851    0.2470030</span></span>
<span><span class="co">#&gt; alpha          1.4409985 0.0022038801 0.22910480    1.03034996    1.2801829</span></span>
<span><span class="co">#&gt; survProb[1]    0.5903455 0.0003800737 0.05223538    0.48591817    0.5548152</span></span>
<span><span class="co">#&gt; lp__        -141.7011034 0.0098800342 1.02027824 -144.47671402 -142.0942676</span></span>
<span><span class="co">#&gt;                      50%          75%        97.5%     n_eff      Rhat</span></span>
<span><span class="co">#&gt; beta0         -2.9322638   -2.8440318   -2.6968268  9887.653 0.9999780</span></span>
<span><span class="co">#&gt; log_alpha      0.3568371    0.4618120    0.6563501 10552.082 0.9999734</span></span>
<span><span class="co">#&gt; alpha          1.4288031    1.5869469    1.9277434 10806.684 0.9999703</span></span>
<span><span class="co">#&gt; survProb[1]    0.5911443    0.6259527    0.6894547 18888.340 1.0000317</span></span>
<span><span class="co">#&gt; lp__        -141.3906390 -140.9749554 -140.7038264 10664.005 0.9999849</span></span>
<span><span class="co">#plot_dist(post_treated)</span></span></code></pre></div>
<p>As was previously done, we can extract and plot the posterior samples
of <span class="math inline">\(S_T(t)\)</span>.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">surv_prob_treated</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">post_treated</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"survProb"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>samp <span class="op">=</span> <span class="va">surv_prob_treated</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">samp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="cn">T</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Posterior Samples of "</span>, <span class="va">S</span><span class="op">[</span><span class="cn">T</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#FFA21F"</span>, fill <span class="op">=</span> <span class="st">"#FFA21F"</span>,</span>
<span>                 position <span class="op">=</span> <span class="st">"identity"</span>, binwidth <span class="op">=</span> <span class="fl">.01</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>We define our marginal treatment effect to be the difference in
survival probabilities at 12 months between the active treatment and
control arms (i.e., <span class="math inline">\(S_T(t=12) -
S_C(t=12)\)</span>). We can obtain a sample from the posterior
distribution for <span class="math inline">\(S_T(t=12) -
S_C(t=12)\)</span> by subtracting the posterior sample of <span class="math inline">\(S_C(t=12)\)</span> from the posterior sample of
<span class="math inline">\(S_T(t=12)\)</span>.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samp_trt_diff</span> <span class="op">&lt;-</span> <span class="va">surv_prob_treated</span> <span class="op">-</span> <span class="va">surv_prob_control</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>samp <span class="op">=</span> <span class="va">samp_trt_diff</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">samp</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Density"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">S</span><span class="op">[</span><span class="cn">T</span><span class="op">]</span>, <span class="st">"(t=12) - "</span>, <span class="va">S</span><span class="op">[</span><span class="va">C</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Posterior Samples of "</span>, <span class="va">S</span><span class="op">[</span><span class="cn">T</span><span class="op">]</span>,</span>
<span>                           <span class="st">"(t=12) - "</span>, <span class="va">S</span><span class="op">[</span><span class="va">C</span><span class="op">]</span>, <span class="st">"(t=12)"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html" class="external-link">geom_histogram</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes_eval.html" class="external-link">after_stat</a></span><span class="op">(</span><span class="va">density</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"#FF0000"</span>, fill <span class="op">=</span> <span class="st">"#FF0000"</span>,</span>
<span>                 position <span class="op">=</span> <span class="st">"identity"</span>, binwidth <span class="op">=</span> <span class="fl">.01</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_density.html" class="external-link">geom_density</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="tte_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
</div>
<div class="section level2">
<h2 id="posterior-summary-statistics">Posterior Summary Statistics<a class="anchor" aria-label="anchor" href="#posterior-summary-statistics"></a>
</h2>
<p>Suppose we want to test the hypotheses <span class="math inline">\(H_0: S_T(t=12) - S_C(t=12) \le 0\)</span> versus
<span class="math inline">\(H_1: S_T(t=12) - S_C(t=12) &gt; 0\)</span>.
We can use our posterior sample for <span class="math inline">\(S_T(t=12) - S_C(t=12)\)</span> to calculate the
posterior probability <span class="math inline">\(Pr(S_T(t=12) -
S_C(t=12) &gt; 0 \mid D)\)</span> (i.e., the probability in favor of
<span class="math inline">\(H_1\)</span>), and we conclude that we have
sufficient evidence in favor of the alternative hypothesis if <span class="math inline">\(Pr(S_T(t=12) - S_C(t=12) &gt; 0 \mid D) &gt;
0.975\)</span>.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">samp_trt_diff</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.9534667</span></span></code></pre></div>
<p>We see that this posterior probability is less than 0.975, and hence
we do not have sufficient evidence in support of the alternative
hypothesis.</p>
<p>With MCMC samples from our posterior distributions, we can calculate
posterior summary statistics such as the mean, median, and standard
deviation. As an example, we calculate these statistics using the
posterior distribution for <span class="math inline">\(S_T(t=12) -
S_C(t=12)\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">samp_trt_diff</span><span class="op">)</span>,</span>
<span>  median <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">samp_trt_diff</span><span class="op">)</span>,</span>
<span>  SD <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/sd.html" class="external-link">sd</a></span><span class="op">(</span><span class="va">samp_trt_diff</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;       mean     median         SD </span></span>
<span><span class="co">#&gt; 0.11726619 0.11920218 0.06795424</span></span></code></pre></div>
<p>We can also calculate credible intervals using the
<code>quantile</code> function.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">samp_trt_diff</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">.025</span>, <span class="fl">.975</span><span class="op">)</span><span class="op">)</span>    <span class="co"># 95% CrI</span></span>
<span><span class="co">#&gt;        2.5%       97.5% </span></span>
<span><span class="co">#&gt; -0.02240224  0.24521556</span></span></code></pre></div>
<p>Lastly, we calculate the effective sample size of the posterior
distribution for <span class="math inline">\(S_C(t=12)\)</span> using
the method by Pennello and Thompson (2008). To do so, we first must
construct the posterior distribution of <span class="math inline">\(S_C(t=12)\)</span> <em>without borrowing from the
external control data</em> (e.g., using a vague prior).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">post_ctrl_no_brrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/calc_post_weibull.html">calc_post_weibull</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_tte_df</span>, <span class="va">trt</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>,</span>
<span>                                       response <span class="op">=</span> <span class="va">y</span>,</span>
<span>                                       event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                       prior <span class="op">=</span> <span class="va">vague_prior</span>,</span>
<span>                                       analysis_time <span class="op">=</span> <span class="fl">12</span><span class="op">)</span></span>
<span><span class="va">surv_prob_ctrl_nb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://mc-stan.org/rstan/reference/stanfit-method-extract.html" class="external-link">extract</a></span><span class="op">(</span><span class="va">post_ctrl_no_brrw</span>, pars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"survProb"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">n_int_ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">int_tte_df</span>, <span class="va">trt</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span><span class="op">)</span>  <span class="co"># sample size of internal control arm</span></span>
<span><span class="va">var_no_brrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">surv_prob_ctrl_nb</span><span class="op">)</span>             <span class="co"># post variance of S_C(t) without borrowing</span></span>
<span><span class="va">var_brrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/cor.html" class="external-link">var</a></span><span class="op">(</span><span class="va">surv_prob_control</span><span class="op">)</span>                <span class="co"># post variance of S_C(t) with borrowing</span></span>
<span><span class="va">ess</span> <span class="op">&lt;-</span> <span class="va">n_int_ctrl</span> <span class="op">*</span> <span class="va">var_no_brrw</span> <span class="op">/</span> <span class="va">var_brrw</span>        <span class="co"># effective sample size</span></span>
<span><span class="va">ess</span></span>
<span><span class="co">#&gt; [1] 123.4881</span></span></code></pre></div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Christina Fillmore, Ben Arancibia, Nate Bean, Abi Terry, GlaxoSmithKline Research &amp; Development Limited.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
